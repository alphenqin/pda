# 阀门仓储 PDA 系统文档汇总

本文档整合项目现有说明与接口文档，作为唯一入口。

---

## 1. 项目简介
本系统面向“阀门仓储管理”场景，PDA 作为一线终端，配合 WMS 与 AGV 调度系统完成入库、送检、回库、出库与任务管理。

### 系统架构
- **WMS 系统**：管理库位、托盘、阀门数据，提供扫码/绑定/查询/任务统计等接口。
- **AGV 调度系统**：接收 PDA 呼叫指令并下发搬运任务。
- **PDA 终端**：操作入口，串联业务流程并调用接口。

---

## 2. 功能模块
- **入库**：托盘扫码 → 阀门绑定 → 呼叫入库
- **送检**：选阀门 → 呼叫送检 → 空托回库
- **回库**：选阀门 → 呼叫托盘 → 阀门回库
- **出库**：选阀门 → 呼叫出库 → 空托回库
- **任务管理**：任务查询 / 取消任务

---

## 3. 技术栈与项目结构
- **语言/平台**：Java / Android
- **SDK**：编译 SDK 23，目标 SDK 23（最低版本按设备要求）
- **主要目录**：
  - `app/src/main/java/com/qs/qs5502demo/` 业务代码
  - `app/src/main/java/com/qs/qs5502demo/api/` 接口封装
  - `app/src/main/java/com/qs/qs5502demo/model/` 数据模型
  - `app/src/main/res/` 页面与资源

---

## 4. 基础约定
### 4.1 通用请求头
```
Content-Type: application/json
Accept: application/json
Authorization: Bearer {token}
```

### 4.2 时间格式
- 日期：`yyyy-MM-dd`
- 日期时间：`yyyy-MM-dd HH:mm:ss`

---

## 5. 服务器地址与配置
### 5.1 默认地址（代码内）
见 `app/src/main/java/com/qs/qs5502demo/api/ApiConfig.java`：
- WMS：`http://10.0.2.2:8080/api`
- AGV：`http://192.168.2.4:81/pt`（由 WMS 调用）

> PDA 端优先配置 WMS 地址；AGV 地址由 WMS 侧对接使用。

### 5.2 localhost 连接说明
- 真机/模拟器下 `localhost` 指向设备自身
- 模拟器使用 `10.0.2.2` 访问开发机
- 真机需使用局域网 IP

---

## 6. WMS 接口（PDA → WMS）
**统一响应格式（推荐）**
```json
{ "code": 200, "message": "操作成功", "data": { } }
```

### 6.1 登录
- `POST /api/auth/login`

### 6.2 托盘扫码
- `POST /api/pallet/scan`
- 入库流程第 1 步

### 6.3 阀门绑定
- `POST /api/valve/bind`
- 入库流程第 2 步

### 6.4 阀门查询
- `POST /api/valve/query`
- 送检/回库/出库“选阀门”页面

### 6.5 任务记录查询
- `POST /api/task/query`
- 任务管理列表查询

---

## 7. AGV 接口（WMS → AGV 调度系统）
PDA 不再直连 AGV，统一由 WMS 下发任务并落库。

### 7.1 PDA → WMS 任务下发接口
- `POST /api/task/dispatch`
- 由 WMS 记录任务并调用 AGV `/pt/taskSent`

### 7.2 PDA → WMS 取消任务接口
- `POST /api/task/cancel`
- 由 WMS 调用 AGV 清空任务并更新本地任务状态

### 7.3 PDA → WMS AGV 信息查询
- `POST /api/agv/info`
- 由 WMS 代理调用 AGV `/pt/agvInfo`

---

## 8. 入库托盘扫码开关（WMS 控制）
登录后 PDA 调用 `POST /pallet/scan/config` 获取 `enabled`：
- **启用**：显示“托盘扫码”，调用 `/pallet/scan`
- **关闭**：显示“选取托盘”，调用 `/bin/available`，托盘号=库位号

WMS 必须支持：
- `POST /pallet/scan/config`
- `POST /bin/available`
- `POST /pallet/scan`
- `POST /valve/bind`
- `POST /valve/query`
- `POST /task/query`
- `POST /task/dispatch`
- `POST /task/cancel`
- `POST /agv/info`
- `POST /task/inbound/lock`

---

## 9. 业务流程（按页面）
### 主界面
- 入口：入库 / 送检 / 回库 / 出库 / 任务管理
- 送检/回库/出库需先检查`/task/inbound/lock`，入库未完成时按钮保持禁用

### 入库
1. 托盘扫码（WMS）
2. 阀门绑定（WMS）
3. 呼叫入库（WMS 下发 AGV 任务）

### 送检
1. 选阀门（WMS）
2. 呼叫送检（WMS 下发 AGV 任务）
3. 空托回库（WMS 下发 AGV 任务）

### 回库
1. 选阀门（WMS）
2. 呼叫托盘（WMS 下发 AGV 任务）
3. 阀门回库（WMS 下发 AGV 任务）

### 出库
1. 选阀门（WMS）
2. 呼叫出库（WMS 下发 AGV 任务）
3. 空托回库（WMS 下发 AGV 任务）

### 任务管理
1. 任务查询（WMS）
2. 取消任务（WMS 下发 AGV 任务）
3. 仅查询本机任务（按 deviceCode 过滤）
4. 查询/取消接口均需携带 deviceCode

---

## 10. 已实现接口清单（代码层）
`WmsApiService`：
- 登录/托盘扫码/阀门绑定/阀门查询/任务查询/扫码开关/可用库位/任务下发/取消任务/AGV信息查询/入库锁定状态

---

## 11. 注意事项
- 所有网络请求需在后台线程执行，主线程更新 UI
- Token 自动添加到请求头（`HttpUtil`）
- 接口失败需提示友好信息
- 任务状态需要与 AGV 同步
- 现场部署时必须确认 WMS/AGV 地址

---

## 12. 版本记录
- 2025-01-15：整理 WMS/AGV 接口与页面映射
- 2025-12-26：整合所有项目文档为单一入口
