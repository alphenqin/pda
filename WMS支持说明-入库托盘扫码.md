# WMS 支持说明（入库托盘扫码）

## 背景
入库流程支持“托盘扫码开关”能力：是否启用由 **WMS 控制**。PDA 在登录时向 WMS 获取开关配置，再决定走“扫码托盘”还是“获取库位”的流程。

## PDA 行为调整（由 WMS 配置决定）
- **登录时获取开关**：
  - PDA 登录成功后调用 `POST /pallet/scan/config` 获取是否启用托盘扫码。
- **托盘扫码启用**：
  - 入库页显示“托盘扫码”入口。
  - PDA 调用 `POST /pallet/scan` 获取托盘信息（托盘号、库位号、置换区等），展示在入库页面。
- **托盘扫码不启用**：
  - 入库页不显示“托盘扫码”，显示“获取库位”。
  - PDA 调用 `POST /bin/available` 获取一个可用库位号，**托盘号 = 库位号**。
  - 绑定阀门时，PDA 将库位号和阀门号绑定，同时托盘号字段使用库位号。

## WMS 需支持的接口（必须）
以下接口均为必须支持：

1. **阀门绑定**
   - 接口：`POST /valve/bind`
   - 关键字段要求：
     - `valveNo`：阀门编号
     - `binCode`：库位号
     - `palletNo`：托盘号
   - **当托盘扫码不启用时**：`palletNo` 与 `binCode` 相同（值均为库位号）。

2. **托盘扫码开关获取**（登录后调用）
   - 接口：`POST /pallet/scan/config`
   - 请求字段：`deviceCode`
   - 返回字段：`enabled`（true/false）

3. **可用库位获取**（托盘扫码不启用时使用）
   - 接口：`POST /bin/available`
   - 返回字段：`binCode`
   - 取位规则：按库位号从小到大排序，返回最小可用库位

4. **阀门查询 / 任务查询**（如现场仍需查看）
   - `POST /valve/query`
   - `POST /task/query`

## 托盘扫码接口（必须）
托盘扫码启用时，WMS 需提供：
- `POST /pallet/scan`
- 返回托盘号、库位号、置换区站点等基础信息。

## 备注
- 托盘扫码开关由 WMS 维护，PDA 仅在登录时拉取并缓存开关值。
- 关闭扫码不会影响阀门绑定与 AGV 调度流程。
